(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[373],{3920:(e,s,t)=>{Promise.resolve().then(t.bind(t,5052))},5052:(e,s,t)=>{"use strict";t.d(s,{default:()=>c});var a=t(4568),l=t(7620),r=t(9725),n=t(263);let i=(0,t(7945).UU)("https://ubbmwemyibhffpqnlvql.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViYm13ZW15aWJoZmZwcW5sdnFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTkxMzUsImV4cCI6MjA3MDOTc1MTM1fQ.pCyjwRWDabZ0kS1DtZH63wvc1Cr4bxMFdoM4NzAKsGk",{auth:{persistSession:!1},realtime:{params:{eventsPerSecond:5}}});function c(e){var s;let{sid:t}=e,[c,o]=(0,l.useState)(""),[d,u]=(0,l.useState)(null),[m,p]=(0,l.useState)([]),[h,x]=(0,l.useState)(!1),[b,j]=(0,l.useState)(null),[v,f]=(0,l.useState)(null);(0,l.useEffect)(()=>{if(!c)return;(async()=>{try{let e=await fetch("/api/jobs/".concat(c),{cache:"no-store"});if(e.ok){let s=await e.json();u(e=>!e||s.version>e.version?s:e)}}catch(e){}})();let e=i.channel("job:".concat(c)).on("postgres_changes",{event:"*",schema:"public",table:"jobs",filter:"id=eq.".concat(c)},e=>{let s=e.new;s&&(p(t=>{var a,l;return["[change] ".concat(e.eventType," v").concat(s.version," ").concat(null!=(a=s.stage)?a:""," ").concat(null!=(l=s.progress)?l:"","%"),...t]}),u(e=>{var t,a,l,r,n;let i={jobId:s.id,status:s.status,stage:null!=(t=s.stage)?t:void 0,progress:null!=(a=s.progress)?a:0,etaSec:null!=(l=s.eta_sec)?l:void 0,files:null!=(r=s.files)?r:void 0,version:null!=(n=s.version)?n:0,updatedAt:s.updated_at,error:s.error_code?{code:s.error_code,message:s.error_message,retryable:s.error_retryable}:void 0};return e?i.version>e.version?i:e:i}))}).subscribe(e=>{p(s=>["[sub] ".concat(e),...s])});return()=>{i.removeChannel(e)}},[c,t]);let g=(0,l.useCallback)(async e=>{if(!(null==e?void 0:e.length))return;let s=e[0];j(s),f(null),x(!0);try{let e=await fetch("/api/upload/presign",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({fileName:s.name,contentType:s.type})});if(!e.ok)throw Error("presign_failed");let{bucket:t,path:a,token:l}=await e.json(),r=await i.storage.from(t).uploadToSignedUrl(a,l,s,{contentType:s.type,upsert:!0});if(r.error)throw r.error;let n=await fetch("/api/upload/complete",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({fileKey:a,size:s.size,mime:s.type})}),c=await n.json();if(!n.ok)throw Error((null==c?void 0:c.error)||"create_job_failed");o(c.jobId),p(e=>["[upload] ".concat(s.name," -> ").concat(t,"/").concat(a),...e])}catch(e){f((null==e?void 0:e.message)||"upload_failed")}finally{x(!1)}},[t]),{getRootProps:w,getInputProps:N,isDragActive:y,acceptedFiles:S}=(0,r.VB)({onDrop:g,multiple:!1,accept:{"audio/mpeg":[".mp3"],"audio/mp4":[".m4a"],"audio/x-m4a":[".m4a"],"audio/wav":[".wav"],"audio/x-wav":[".wav"]},maxFiles:1});function k(e){let{label:s,url:t}=e,r=(0,l.useRef)(null),i=(0,l.useRef)(null),[c,o]=(0,l.useState)(!1);return(0,l.useEffect)(()=>{if(!r.current||!t)return;let e=n.A.create({container:r.current,waveColor:"#5b5b5f",progressColor:"#a78bfa",height:64,barWidth:2,normalize:!0,url:t});return i.current=e,e.on("play",()=>o(!0)),e.on("pause",()=>o(!1)),()=>{e.destroy()}},[t]),(0,a.jsxs)("div",{className:"bg-white/5 rounded p-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("span",{className:"w-24 inline-block text-sm text-white/70",children:s}),t?(0,a.jsx)("a",{className:"text-purple-400 hover:text-purple-300 transition-colors",href:t,target:"_blank",rel:"noreferrer",children:"Download"}):(0,a.jsx)("span",{className:"text-white/40 text-sm",children:"Not ready"})]}),(0,a.jsx)("div",{children:(0,a.jsx)("button",{className:"px-3 py-1 rounded text-sm transition-colors hover:bg-white/10 disabled:opacity-50",onClick:()=>{var e;null==(e=i.current)||e.playPause()},disabled:!t,children:c?"Pause":"Play"})})]}),(0,a.jsx)("div",{className:"w-full",children:t?(0,a.jsx)("div",{ref:r,className:"w-full"}):(0,a.jsx)("div",{className:"h-16 bg-white/5 rounded"})})]})}return(0,a.jsxs)("main",{className:"max-w-5xl mx-auto p-6",children:[(0,a.jsxs)("header",{className:"flex items-center justify-between mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold tracking-tight",children:"STEM SEPARATOR v2.0"}),(0,a.jsxs)("p",{className:"muted",children:["Session: ",t.slice(0,8)]})]}),(0,a.jsx)(function(){let e=(null==d?void 0:d.status)==="completed"?"Complete":(null==d?void 0:d.status)==="processing"?"Processing":c?"Queued":"Upload",s="Complete"===e?"bg-emerald-500/20 text-emerald-300":"Processing"===e?"bg-purple-500/20 text-purple-300":"bg-white/10 text-white/60";return(0,a.jsx)("span",{className:"px-2 py-1 rounded text-xs ".concat(s),children:e})},{})]}),(0,a.jsxs)("section",{className:"card p-6 mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsx)("h2",{className:"text-lg font-medium",children:"Upload Source"}),b&&(0,a.jsxs)("span",{className:"muted text-sm",children:[b.name," • ",(b.size/1024/1024).toFixed(2)," MB"]})]}),(0,a.jsxs)("div",{...w({className:"border-2 border-dashed rounded-md p-8 text-center cursor-pointer transition-colors ".concat(y?"border-purple-500 bg-purple-500/10":"border-white/30 hover:border-white/50")}),children:[(0,a.jsx)("input",{...N()}),(0,a.jsx)("p",{className:"mb-2 text-white/90",children:"Drag & drop audio file here, or click to select"}),(0,a.jsx)("p",{className:"text-white/60 text-sm",children:"Supported: MP3, M4A, WAV • Max ~100MB"})]}),(0,a.jsxs)("div",{className:"mt-4 flex items-center gap-3",children:[(0,a.jsx)("button",{className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors disabled:opacity-50",onClick:()=>S.length&&g(S),disabled:h,children:h?"Uploading…":"Upload & Start"}),(0,a.jsx)("input",{className:"bg-white/5 border border-white/10 rounded px-3 py-2 w-[360px]",placeholder:"Or paste existing Job ID",value:c,onChange:e=>o(e.target.value)}),v&&(0,a.jsx)("span",{className:"text-red-400 text-sm",children:v})]})]}),(0,a.jsxs)("section",{className:"card p-6 mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsx)("h2",{className:"text-lg font-medium",children:"Progress"}),(0,a.jsx)("span",{className:"muted text-sm",children:(null==d?void 0:d.etaSec)?"ETA ~ ".concat(Math.ceil(d.etaSec/60)," min"):"—"})]}),(0,a.jsx)(function(){var e;let s=Math.max(0,Math.min(100,null!=(e=null==d?void 0:d.progress)?e:0));return(0,a.jsx)("div",{className:"progress w-full",children:(0,a.jsx)("div",{style:{width:"".concat(s,"%")}})})},{}),(0,a.jsxs)("div",{className:"mt-2 text-sm muted",children:["Stage: ",null!=(s=null==d?void 0:d.stage)?s:c?"queued":"idle"]})]}),(0,a.jsxs)("section",{className:"card p-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsx)("h2",{className:"text-lg font-medium",children:"Stems"}),(0,a.jsx)("span",{className:"muted text-sm",children:"Solo/Muteは次版で追加"})]}),(0,a.jsx)("div",{className:"space-y-4",children:[{key:"vocals",label:"Vocal"},{key:"drums",label:"Drums"},{key:"bass",label:"Bass"},{key:"other",label:"Other"}].map(e=>{var s;let{key:t,label:l}=e;return(0,a.jsx)(k,{label:l,url:null==d||null==(s=d.files)?void 0:s[t]},t)})})]}),(0,a.jsxs)("section",{className:"mt-6",children:[(0,a.jsx)("h3",{className:"text-sm font-medium mb-2",children:"Events"}),(0,a.jsx)("ul",{className:"text-xs space-y-1 max-h-40 overflow-auto",children:m.map((e,s)=>(0,a.jsx)("li",{className:"muted",children:e},s))})]})]})}}},e=>{e.O(0,[667,587,18,358],()=>e(e.s=3920)),_N_E=e.O()}]);